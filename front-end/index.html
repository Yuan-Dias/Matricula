<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGA - Sistema Acadêmico</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .sidebar { background: #1a202c; min-height: 100vh; color: #cbd5e0; }
        .nav-link { color: inherit; transition: 0.2s; border-radius: 8px; margin-bottom: 5px; cursor: pointer;}
        .nav-link:hover, .nav-link.active { background: #2d3748; color: white; transform: translateX(5px); }
        .nav-link.active { border-left: 4px solid #3182ce; }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 10px; }
        .card-header { background: white; border-bottom: 1px solid #edf2f7; font-weight: 600; padding: 15px 20px; border-radius: 10px 10px 0 0 !important; }
        .login-wrapper { height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%); }
        .login-box { width: 100%; max-width: 420px; background: white; padding: 40px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .fade-in { animation: fadeIn 0.4s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Abas personalizadas */
        .nav-tabs .nav-link { color: #495057; }
        .nav-tabs .nav-link.active { font-weight: bold; color: #0d6efd; }
    </style>
</head>
<body>

<div id="login-view" class="login-wrapper">
    <div class="login-box text-center">
        <i class="fas fa-university fa-3x text-primary mb-3"></i>
        <h3 class="fw-bold mb-1">Portal SGA</h3>
        <p class="text-muted small mb-4">Sistema de Gestão Acadêmica</p>

        <div class="form-floating mb-3 text-start">
            <input type="email" id="loginEmail" class="form-control" placeholder="Email" value="admin@escola.com">
            <label>Email / Login</label>
        </div>
        <div class="form-floating mb-4 text-start">
            <input type="password" id="loginSenha" class="form-control" placeholder="Senha" value="123">
            <label>Senha</label>
        </div>

        <button onclick="login()" class="btn btn-primary w-100 py-2 fw-bold mb-3">ENTRAR</button>
        <div class="border-top pt-3">
            <button onclick="criarAdminPadrao()" class="btn btn-sm btn-outline-secondary w-100">
                <i class="fas fa-magic"></i> Criar Admin Padrão
            </button>
        </div>
    </div>
</div>

<div id="app-view" class="container-fluid d-none fade-in">
    <div class="row">
        <div class="col-md-2 sidebar p-4 d-flex flex-column">
            <h4 class="fw-bold text-white mb-4"><i class="fas fa-graduation-cap me-2"></i>SGA Pro</h4>
            <nav class="nav flex-column mb-auto">
                <a class="nav-link active" onclick="navigate('secretaria')"><i class="fas fa-building me-2 w-25"></i> Secretaria</a>
                <a class="nav-link" onclick="navigate('academico')"><i class="fas fa-book-reader me-2 w-25"></i> Acadêmico</a>
            </nav>
            <div class="border-top border-secondary pt-3 mt-4">
                <small class="d-block text-secondary mb-1">Logado como:</small>
                <div class="fw-bold text-white mb-2" id="user-display">Usuário</div>
                <button onclick="logout()" class="btn btn-outline-danger btn-sm w-100"><i class="fas fa-sign-out-alt"></i> Sair</button>
            </div>
        </div>

        <div class="col-md-10 p-4" style="height: 100vh; overflow-y: auto;">

            <div id="view-secretaria" class="view-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3 class="text-secondary">Painel Administrativo</h3>
                </div>

                <ul class="nav nav-tabs mb-4" id="secretariaTabs">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-cadastros">
                            <i class="fas fa-plus-circle me-2"></i>Novos Cadastros
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-listas" onclick="carregarTodasListas()">
                            <i class="fas fa-list me-2"></i>Gerenciar Dados (Editar/Excluir)
                        </button>
                    </li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane fade show active" id="tab-cadastros">

                        <div class="card mb-4 border-start border-primary border-4">
                            <div class="card-header text-primary"><i class="fas fa-user-plus me-2"></i> 1. Usuário (Professor/Admin)</div>
                            <div class="card-body">
                                <form onsubmit="salvarUsuario(event)">
                                    <input type="hidden" id="userId"> <div class="row g-2">
                                    <div class="col-md-4"><input type="text" id="userNome" class="form-control" placeholder="Nome Completo" required></div>
                                    <div class="col-md-3"><input type="email" id="userLogin" class="form-control" placeholder="Email" required></div>
                                    <div class="col-md-2"><input type="text" id="userPass" class="form-control" placeholder="Senha" required></div>
                                    <div class="col-md-3">
                                        <select id="userTipo" class="form-select">
                                            <option value="PROFESSOR">Professor</option>
                                            <option value="INSTITUICAO">Instituição</option>
                                        </select>
                                    </div>
                                    <div class="col-12 mt-2">
                                        <button type="submit" id="btnUser" class="btn btn-primary w-100">Salvar Usuário</button>
                                        <button type="button" onclick="limparForm('user')" class="btn btn-secondary w-100 mt-1 d-none" id="btnCancelUser">Cancelar Edição</button>
                                    </div>
                                </div>
                                </form>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card h-100 border-start border-success border-4">
                                    <div class="card-header text-success"><i class="fas fa-user-graduate me-2"></i> 2. Aluno</div>
                                    <div class="card-body">
                                        <form onsubmit="salvarAluno(event)">
                                            <input type="hidden" id="alunoId"> <div class="mb-2"><input id="alunoNome" class="form-control" placeholder="Nome" required></div>
                                            <div class="mb-2"><input id="alunoEmail" type="email" class="form-control" placeholder="Email" required></div>
                                            <div class="mb-3"><input id="alunoCpf" class="form-control" placeholder="CPF" required></div>
                                            <button type="submit" id="btnAluno" class="btn btn-outline-success w-100">Salvar Aluno</button>
                                            <button type="button" onclick="limparForm('aluno')" class="btn btn-sm btn-secondary w-100 mt-2 d-none" id="btnCancelAluno">Cancelar</button>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6 mb-4">
                                <div class="card h-100 border-start border-info border-4">
                                    <div class="card-header text-info"><i class="fas fa-shapes me-2"></i> 3. Curso</div>
                                    <div class="card-body">
                                        <form onsubmit="salvarCurso(event)">
                                            <input type="hidden" id="cursoId"> <div class="row g-2 mb-2">
                                            <div class="col-7"><input id="cursoNome" class="form-control" placeholder="Nome" required></div>
                                            <div class="col-5"><input id="cursoCarga" type="number" class="form-control" placeholder="Horas" required></div>
                                        </div>
                                            <div class="mb-2"><input id="cursoDesc" class="form-control" placeholder="Descrição" required></div>
                                            <div class="mb-2">
                                                <select id="selProfCoordenador" class="form-select"></select>
                                            </div>
                                            <button type="submit" id="btnCurso" class="btn btn-outline-info w-100">Salvar Curso</button>
                                            <button type="button" onclick="limparForm('curso')" class="btn btn-sm btn-secondary w-100 mt-2 d-none" id="btnCancelCurso">Cancelar</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card border-warning border-start border-4">
                            <div class="card-header text-warning text-dark"><i class="fas fa-link me-2"></i> 4. Gestão de Matérias e Matrículas</div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 border-end">
                                        <h6 class="fw-bold mb-3">Matéria (Disciplina)</h6>
                                        <form onsubmit="salvarMateria(event)">
                                            <input type="hidden" id="matId"> <div class="mb-2"><input id="matNome" class="form-control" placeholder="Nome" required></div>
                                            <div class="mb-2"><input id="matDesc" class="form-control" placeholder="Descrição" required></div>
                                            <div class="row g-2 mb-3">
                                                <div class="col-6"><select id="selMatCurso" class="form-select" required></select></div>
                                                <div class="col-6"><select id="selMatProf" class="form-select" required></select></div>
                                            </div>
                                            <button type="submit" id="btnMat" class="btn btn-warning w-100">Salvar Matéria</button>
                                            <button type="button" onclick="limparForm('mat')" class="btn btn-sm btn-secondary w-100 mt-2 d-none" id="btnCancelMat">Cancelar</button>
                                        </form>
                                    </div>

                                    <div class="col-md-6 ps-4">
                                        <h6 class="fw-bold mb-3">Realizar Matrícula</h6>
                                        <div class="mb-3">
                                            <label class="small text-muted">Aluno</label>
                                            <select id="selMatriculaAluno" class="form-select mb-2"></select>
                                            <label class="small text-muted">Matéria</label>
                                            <select id="selMatriculaMateria" class="form-select mb-3"></select>
                                            <button onclick="realizarMatricula()" class="btn btn-dark w-100"><i class="fas fa-check me-2"></i> Matricular</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="tab-listas">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-header bg-success text-white">Alunos Cadastrados</div>
                                    <div class="card-body p-0 table-responsive" style="max-height: 300px">
                                        <table class="table table-striped mb-0 text-center">
                                            <thead><tr><th>Nome</th><th>Ações</th></tr></thead>
                                            <tbody id="lista-alunos"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-header bg-info text-white">Cursos Cadastrados</div>
                                    <div class="card-body p-0 table-responsive" style="max-height: 300px">
                                        <table class="table table-striped mb-0 text-center">
                                            <thead><tr><th>Nome</th><th>Ações</th></tr></thead>
                                            <tbody id="lista-cursos"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-header bg-warning text-dark">Matérias Cadastradas</div>
                                    <div class="card-body p-0 table-responsive" style="max-height: 300px">
                                        <table class="table table-striped mb-0 text-center">
                                            <thead><tr><th>Nome</th><th>Curso</th><th>Ações</th></tr></thead>
                                            <tbody id="lista-materias"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-header bg-primary text-white">Usuários (Profs/Admin)</div>
                                    <div class="card-body p-0 table-responsive" style="max-height: 300px">
                                        <table class="table table-striped mb-0 text-center">
                                            <thead><tr><th>Nome</th><th>Tipo</th><th>Ações</th></tr></thead>
                                            <tbody id="lista-usuarios"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> </div>

            <div id="view-academico" class="view-section d-none">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="text-secondary">Boletim & Diário de Classe</h3>
                    <button onclick="carregarMatriculas()" class="btn btn-primary"><i class="fas fa-sync me-2"></i> Atualizar</button>
                </div>

                <div class="card mb-4 bg-light border border-secondary" id="painel-lancar-nota">
                    <div class="card-body">
                        <h5 class="card-title text-primary fw-bold"><i class="fas fa-pen-nib me-2"></i>Lançar Nota</h5>
                        <div class="row g-3 align-items-center">
                            <div class="col-md-2"><input type="text" id="notaIdMatricula" class="form-control text-center" readonly placeholder="ID #"></div>
                            <div class="col-md-6"><input type="text" class="form-control" id="notaNomeAluno" readonly placeholder="Selecione um aluno abaixo..." style="background: transparent; border: none; font-weight: bold;"></div>
                            <div class="col-md-2"><input type="number" id="notaValor" class="form-control" placeholder="Nota" min="0" max="10" step="0.1"></div>
                            <div class="col-md-2"><button onclick="salvarNota()" class="btn btn-success w-100 fw-bold">SALVAR</button></div>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm">
                    <div class="card-body p-0">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-dark"><tr><th>ID</th><th>Aluno</th><th>Matéria</th><th>Curso</th><th class="text-center">Nota</th><th class="text-end">Ações</th></tr></thead>
                            <tbody id="tabela-matriculas"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="toast" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body fs-6" id="toast-msg">Mensagem</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_URL = "http://localhost:8080";
    let token = localStorage.getItem("sga_token");

    // --- INICIALIZAÇÃO ---
    window.onload = () => {
        if(token) {
            mostrarApp();
            carregarListasAuxiliares();
            carregarMatriculas();
        }
    };

    function mostrarApp() {
        document.getElementById('login-view').classList.add('d-none');
        document.getElementById('app-view').classList.remove('d-none');
        const payload = parseJwt(token);
        if(payload) document.getElementById('user-display').innerText = payload.sub;
    }

    function navigate(view) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none'));
        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${view}`).classList.remove('d-none');

        if(view === 'secretaria') carregarListasAuxiliares();
        if(view === 'academico') carregarMatriculas();
    }

    function logout() {
        localStorage.removeItem("sga_token");
        location.reload();
    }

    // --- API BLINDADA ---
    async function fetchAPI(endpoint, method = "GET", body = null) {
        const token = localStorage.getItem("sga_token");
        const headers = { 'Content-Type': 'application/json' };
        if (token && token !== "null") headers['Authorization'] = `Bearer ${token}`;

        const options = { method, headers };
        if (body) options.body = JSON.stringify(body);

        try {
            const res = await fetch(`${API_URL}${endpoint}`, options);
            const text = await res.text();

            if (!res.ok) {
                if(res.status === 403) throw new Error("Sem permissão ou Login expirado!");
                try {
                    const jsonErr = JSON.parse(text);
                    throw new Error(jsonErr.message || jsonErr.error || text);
                } catch(e) { throw new Error(text || `Erro ${res.status}`); }
            }
            if (!text) return {};
            try { return JSON.parse(text); } catch (e) { return { mensagem: text }; }
        } catch (err) {
            console.error(err);
            msg(err.message, 'danger');
            throw err;
        }
    }

    function parseJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; } }
    function msg(texto, tipo = 'primary') {
        const el = document.getElementById('toast');
        document.getElementById('toast-msg').innerText = texto;
        el.className = `toast align-items-center text-white border-0 bg-${tipo}`;
        new bootstrap.Toast(el).show();
    }

    // --- FUNÇÕES GENÉRICAS DE CRUD ---

    // Excluir Item
    async function excluir(endpoint, id, callback) {
        if(!confirm("Tem certeza que deseja excluir este item?")) return;
        try {
            await fetchAPI(`${endpoint}/${id}`, 'DELETE');
            msg("Item excluído com sucesso!", "success");
            if(callback) callback(); // Recarrega a lista
            carregarListasAuxiliares(); // Atualiza dropdowns
        } catch(e) {}
    }

    // Preparar Edição (Preenche o form e muda para modo PUT)
    function editar(tipo, obj) {
        // Volta para a aba de cadastros
        const tabEl = document.querySelector('button[data-bs-target="#tab-cadastros"]');
        bootstrap.Tab.getInstance(tabEl).show();

        if (tipo === 'aluno') {
            document.getElementById('alunoId').value = obj.id;
            document.getElementById('alunoNome').value = obj.nome;
            document.getElementById('alunoEmail').value = obj.email;
            document.getElementById('alunoCpf').value = obj.cpf;

            alternarBotaoForm('aluno', true);
        }
        else if (tipo === 'curso') {
            document.getElementById('cursoId').value = obj.id;
            document.getElementById('cursoNome').value = obj.nome;
            document.getElementById('cursoCarga').value = obj.cargaHoraria;
            document.getElementById('cursoDesc').value = obj.descricao;
            document.getElementById('selProfCoordenador').value = obj.idProfessor || obj.professor?.id; // Tenta pegar o ID de formas diferentes

            alternarBotaoForm('curso', true);
        }
        else if (tipo === 'materia') {
            document.getElementById('matId').value = obj.id;
            document.getElementById('matNome').value = obj.nome;
            document.getElementById('matDesc').value = obj.descricao;
            document.getElementById('selMatCurso').value = obj.idCurso || obj.curso?.id;
            document.getElementById('selMatProf').value = obj.idProfessor || obj.professor?.id;

            alternarBotaoForm('mat', true);
        }
        else if (tipo === 'user') {
            document.getElementById('userId').value = obj.id;
            document.getElementById('userNome').value = obj.nome;
            document.getElementById('userLogin').value = obj.login;
            document.getElementById('userPass').placeholder = "Deixe vazio para manter a senha";
            document.getElementById('userPass').value = ""; // Senha não volta
            document.getElementById('userTipo').value = obj.tipoUsuario;

            alternarBotaoForm('user', true);
        }
    }

    function alternarBotaoForm(tipo, editando) {
        const btnSalvar = document.getElementById(tipo === 'mat' ? 'btnMat' : 'btn' + tipo.charAt(0).toUpperCase() + tipo.slice(1));
        const btnCancel = document.getElementById(tipo === 'mat' ? 'btnCancelMat' : 'btnCancel' + tipo.charAt(0).toUpperCase() + tipo.slice(1));

        if(editando) {
            btnSalvar.innerText = "Atualizar Dados";
            btnSalvar.classList.replace('btn-primary', 'btn-warning');
            btnSalvar.classList.replace('btn-outline-success', 'btn-warning');
            btnSalvar.classList.replace('btn-outline-info', 'btn-warning');
            btnCancel.classList.remove('d-none');
        } else {
            // Reseta cores originais
            btnSalvar.innerText = "Salvar";
            btnSalvar.classList.add(tipo === 'user' ? 'btn-primary' : (tipo === 'aluno' ? 'btn-outline-success' : (tipo === 'curso' ? 'btn-outline-info' : 'btn-warning')));
            btnSalvar.classList.remove('btn-warning');
            btnCancel.classList.add('d-none');
        }
    }

    function limparForm(tipo) {
        document.querySelector(`#btn${tipo === 'mat' ? 'Mat' : tipo.charAt(0).toUpperCase() + tipo.slice(1)}`).closest('form').reset();
        document.getElementById(`${tipo}Id`).value = ""; // Limpa ID oculto
        alternarBotaoForm(tipo, false);
    }

    // --- FUNÇÕES DE PERSISTÊNCIA (CREATE / UPDATE) ---

    // 1. Usuários
    async function salvarUsuario(e) {
        e.preventDefault();
        const id = document.getElementById('userId').value;
        const dados = {
            nome: document.getElementById('userNome').value,
            login: document.getElementById('userLogin').value,
            tipo: document.getElementById('userTipo').value
        };
        // Só envia senha se foi digitada
        const senha = document.getElementById('userPass').value;
        if(senha) dados.senha = senha;

        try {
            if(id) { // UPDATE (PUT)
                // Se o backend exigir o ID no corpo, descomente abaixo:
                // dados.id = id;
                await fetchAPI(`/usuarios/${id}`, 'PUT', dados);
                msg("Usuário atualizado!", "success");
            } else { // CREATE (POST)
                if(!senha) return msg("Senha obrigatória para novo usuário", "warning");
                await fetchAPI('/usuarios', 'POST', dados);
                msg("Usuário criado!", "success");
            }
            limparForm('user');
            carregarTodasListas();
        } catch(e) {}
    }

    // 2. Alunos
    async function salvarAluno(e) {
        e.preventDefault();
        const id = document.getElementById('alunoId').value;
        const dados = {
            nome: document.getElementById('alunoNome').value,
            email: document.getElementById('alunoEmail').value,
            cpf: document.getElementById('alunoCpf').value
        };

        try {
            if(id) {
                await fetchAPI(`/alunos/${id}`, 'PUT', dados);
                msg("Aluno atualizado!", "success");
            } else {
                await fetchAPI('/alunos', 'POST', dados);
                msg("Aluno criado!", "success");
            }
            limparForm('aluno');
            carregarTodasListas();
        } catch(e) {}
    }

    // 3. Cursos
    async function salvarCurso(e) {
        e.preventDefault();
        const id = document.getElementById('cursoId').value;
        const dados = {
            nome: document.getElementById('cursoNome').value,
            descricao: document.getElementById('cursoDesc').value,
            cargaHoraria: document.getElementById('cursoCarga').value,
            idProfessor: parseInt(document.getElementById('selProfCoordenador').value)
        };

        try {
            if(id) {
                await fetchAPI(`/cursos/${id}`, 'PUT', dados);
                msg("Curso atualizado!", "success");
            } else {
                await fetchAPI('/cursos', 'POST', dados);
                msg("Curso criado!", "success");
            }
            limparForm('curso');
            carregarTodasListas();
        } catch(e) {}
    }

    // 4. Materias
    async function salvarMateria(e) {
        e.preventDefault();
        const id = document.getElementById('matId').value;
        const dados = {
            nome: document.getElementById('matNome').value,
            descricao: document.getElementById('matDesc').value,
            idCurso: parseInt(document.getElementById('selMatCurso').value),
            idProfessor: parseInt(document.getElementById('selMatProf').value)
        };

        try {
            if(id) {
                await fetchAPI(`/materias/${id}`, 'PUT', dados);
                msg("Matéria atualizada!", "success");
            } else {
                await fetchAPI('/materias', 'POST', dados);
                msg("Matéria criada!", "success");
            }
            limparForm('mat');
            carregarTodasListas();
        } catch(e) {}
    }

    async function realizarMatricula() {
        const dados = {
            idAluno: document.getElementById('selMatriculaAluno').value,
            idMateria: document.getElementById('selMatriculaMateria').value
        };
        try {
            await fetchAPI('/matriculas', 'POST', dados);
            msg("Matrícula realizada!", "success");
        } catch(e) {}
    }

    // --- CARREGAMENTO DE DADOS ---

    async function carregarListasAuxiliares() {
        try {
            const cursos = await fetchAPI('/cursos');
            const profs = await fetchAPI('/usuarios/professores');
            const alunos = await fetchAPI('/alunos');
            const materias = await fetchAPI('/materias');

            preencherSelect('selMatCurso', cursos);
            preencherSelect('selProfCoordenador', profs);
            preencherSelect('selMatProf', profs);
            preencherSelect('selMatriculaAluno', alunos);
            preencherSelect('selMatriculaMateria', materias);
        } catch (e) { console.log(e); }
    }

    function preencherSelect(id, lista) {
        const el = document.getElementById(id);
        if(!el) return;
        const atual = el.value; // Tenta manter seleção
        el.innerHTML = lista.map(i => `<option value="${i.id}">${i.nome}</option>`).join('');
        if(atual) el.value = atual;
    }

    async function carregarTodasListas() {
        // Carrega Alunos
        const alunos = await fetchAPI('/alunos');
        document.getElementById('lista-alunos').innerHTML = alunos.map(a => `
            <tr>
                <td>${a.nome}</td>
                <td>
                    <button class="btn btn-sm btn-outline-warning" onclick='editar("aluno", ${JSON.stringify(a)})'><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="excluir('/alunos', ${a.id}, carregarTodasListas)"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');

        // Carrega Cursos
        const cursos = await fetchAPI('/cursos');
        document.getElementById('lista-cursos').innerHTML = cursos.map(c => `
            <tr>
                <td>${c.nome}</td>
                <td>
                    <button class="btn btn-sm btn-outline-warning" onclick='editar("curso", ${JSON.stringify(c)})'><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="excluir('/cursos', ${c.id}, carregarTodasListas)"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');

        // Carrega Materias
        const materias = await fetchAPI('/materias');
        document.getElementById('lista-materias').innerHTML = materias.map(m => `
            <tr>
                <td>${m.nome}</td>
                <td><small>${m.curso ? m.curso.nome : '-'}</small></td>
                <td>
                    <button class="btn btn-sm btn-outline-warning" onclick='editar("materia", ${JSON.stringify(m)})'><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="excluir('/materias', ${m.id}, carregarTodasListas)"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');

        // Carrega Usuários
        try {
            // Nota: Se não tiver endpoint '/usuarios' que liste todos, isso vai falhar.
            // Normalmente o endpoint seria '/usuarios'
            const users = await fetchAPI('/usuarios');
            // Filtrar array se necessário ou backend já retorna lista
            if(Array.isArray(users)){
                document.getElementById('lista-usuarios').innerHTML = users.map(u => `
                    <tr>
                        <td>${u.nome}</td>
                        <td><span class="badge bg-secondary">${u.tipoUsuario}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-warning" onclick='editar("user", ${JSON.stringify(u)})'><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="excluir('/usuarios', ${u.id}, carregarTodasListas)"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            }
        } catch(e){ console.log("Endpoint listar usuarios pode não existir ainda"); }
    }

    // --- ACADÊMICO ---
    async function carregarMatriculas() {
        const tbody = document.getElementById('tabela-matriculas');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">Carregando...</td></tr>';
        try {
            const dados = await fetchAPI('/matriculas');
            tbody.innerHTML = '';
            if(dados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum registro.</td></tr>';
                return;
            }
            dados.forEach(m => {
                let badge = m.nota !== null ? (m.nota >= 6 ? 'bg-success' : 'bg-danger') : 'bg-secondary';
                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold text-muted">#${m.id}</td>
                        <td>${m.nomeAluno}</td>
                        <td>${m.nomeMateria}</td>
                        <td>${m.nomeCurso}</td>
                        <td class="text-center"><span class="badge ${badge} nota-badge">${m.nota !== null ? m.nota : '-'}</span></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary" onclick="prepararNota(${m.id}, '${m.nomeAluno}', ${m.nota})"><i class="fas fa-edit"></i> Nota</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="excluir('/matriculas', ${m.id}, carregarMatriculas)"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
        } catch(e) { tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro.</td></tr>'; }
    }

    function prepararNota(id, nome, nota) {
        document.getElementById('notaIdMatricula').value = id;
        document.getElementById('notaNomeAluno').value = nome;
        document.getElementById('notaValor').value = nota || '';
        document.getElementById('painel-lancar-nota').scrollIntoView({behavior: 'smooth'});
        document.getElementById('notaValor').focus();
    }

    async function salvarNota() {
        const dados = { idMatricula: document.getElementById('notaIdMatricula').value, nota: document.getElementById('notaValor').value };
        try {
            await fetchAPI('/matriculas/notas', 'PUT', dados);
            msg("Nota salva!", "success");
            carregarMatriculas();
            document.getElementById('notaIdMatricula').value = '';
            document.getElementById('notaNomeAluno').value = '';
            document.getElementById('notaValor').value = '';
        } catch(e) {}
    }

    // --- LOGIN ---
    async function login() {
        const login = document.getElementById('loginEmail').value;
        const senha = document.getElementById('loginSenha').value;
        try {
            const data = await fetchAPI('/login', 'POST', { login, senha });
            if(data.token) {
                localStorage.setItem("sga_token", data.token);
                token = data.token;
                mostrarApp();
                location.reload();
            }
        } catch(e) {}
    }

    async function criarAdminPadrao() {
        try {
            await fetchAPI('/usuarios', 'POST', { login: 'admin@escola.com', senha: '123', tipo: 'INSTITUICAO', nome: 'Admin' });
            msg("Admin criado: admin@escola.com / 123", "success");
        } catch(e) { msg("Provavelmente já existe.", "warning"); }
    }
</script>
</body>
</html>